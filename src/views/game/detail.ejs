<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title><%= game.title %> - Chi ti·∫øt</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <header>
        <div class="header-inner">
            <a href="/"><h1>üéÆ CyberStore</h1></a>
            <div class="nav-group">
                <% 
                   // FIX 1: Ki·ªÉm tra an to√†n cho cart
                   let totalQty = 0; 
                   if (typeof cart !== 'undefined' && cart) {
                       cart.forEach(i => totalQty += i.quantity);
                   }
                %>
                <a href="/cart" class="btn btn-cart">Gi·ªè h√†ng (<%= totalQty %>)</a>
            </div>
        </div>
    </header>

    <div class="container">
        <a href="/" class="btn btn-detail" style="width: auto; display: inline-block; margin-bottom: 20px;">‚Üê Quay l·∫°i</a>

        <div class="detail-container">
            <div class="detail-img">
                <img src="<%= game.imageUrl %>" alt="<%= game.title %>">
            </div>
            <div class="detail-info">
                <h1 style="font-size: 2.5rem; margin-top: 0; margin-bottom: 10px;"><%= game.title %></h1>
                
                <div class="game-category-tag">
                    <span>üìÅ Th·ªÉ lo·∫°i:</span>
                    <span><%= game.category ? game.category : "Ch∆∞a c·∫≠p nh·∫≠t" %></span> 
                </div>
                <div class="detail-price">$<%= game.price %></div>
                <p class="detail-desc"><%= game.description %></p>

                <div style="display: flex; gap: 15px;">
                    <a href="/cart/add/<%= game._id %>" class="btn btn-detail" style="padding: 15px 30px; font-size: 0.9rem;">TH√äM V√ÄO GI·ªé</a>
                    <a href="/checkout/quick/<%= game._id %>" class="btn btn-buy" style="margin-top:0; padding: 15px 30px; font-size: 1.1rem;">MUA NGAY</a>
                </div>
            </div>
        </div>

        <div class="container" style="margin-top: 40px; background: var(--card-bg); padding: 30px; border-radius: 15px;">
            <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px;">‚≠ê ƒê√°nh gi√° t·ª´ ng∆∞·ªùi ch∆°i</h3>

            <% if (typeof currentUser !== 'undefined' && currentUser) { %>
                <form action="/game/<%= game._id %>/review" method="POST" style="margin-bottom: 30px;">
                    <label>ƒê√°nh gi√°:</label>
                    <select name="rating" style="padding: 5px; background: #333; color: white; border: none; margin-bottom: 10px;">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Tuy·ªát v·ªùi)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (T·ªët)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (B√¨nh th∆∞·ªùng)</option>
                    </select>
                    <textarea name="comment" rows="3" placeholder="Vi·∫øt c·∫£m nh·∫≠n c·ªßa b·∫°n..." style="width: 100%; background: #121212; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px;" required></textarea>
                    <button type="submit" class="btn btn-admin" style="margin-top: 10px;">G·ª≠i ƒê√°nh Gi√°</button>
                </form>
            <% } else { %>
                <p>Vui l√≤ng <a href="/login" style="color: var(--accent-color);">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë√°nh gi√°.</p>
            <% } %>

            <% if (game.reviews && game.reviews.length > 0) { %>
                <% game.reviews.slice().reverse().forEach(review => { %>
                    <div style="border-bottom: 1px solid #333; padding: 15px 0;">
                        <div style="font-weight: bold; color: var(--accent-color);">
                            <%= review.username %> <span style="color: gold;"><%= '‚≠ê'.repeat(review.rating) %></span>
                        </div>
                        <p style="margin: 5px 0; color: #ccc;"><%= review.comment %></p>
                        <small style="color: #666;">
                            <%= review.date ? new Date(review.date).toLocaleDateString('vi-VN') : '' %>
                        </small>
                    </div>
                <% }) %>
            <% } else { %>
                <p style="color: #666; font-style: italic;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>
            <% } %>
        </div>
    </div>

    <footer>
        <div style="text-align: center; padding: 20px; color: #666; border-top: 1px solid #333; margin-top: 50px;">
            &copy; 2024 CyberStore. All rights reserved.
        </div>
    </footer>
</body>
</html>